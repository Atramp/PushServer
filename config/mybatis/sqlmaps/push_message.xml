<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PUSH_MESSAGE">
    <select id="selectAllMessages" resultType="com.teradata.pushserver.bean.message.PushMessageBean">
        SELECT
            ID,
            MESSAGE_TYPE,
            MESSAGE_TITLE,
            DESCRIPTION,
            URL,
            CONTENT,
            CREATE_TIME
        FROM
            ${dbName}.KPI_MBL_BI_PUSH_MESSAGE
        ORDER BY CREATE_TIME DESC
    </select>

    <insert id="insertMessage">
        INSERT INTO
            ${dbName}.KPI_MBL_BI_PUSH_MESSAGE (ID,MESSAGE_TYPE,MESSAGE_TITLE,DESCRIPTION,CONTENT,URL,CREATE_TIME)
        VALUES
            (#{MESSAGE.id},#{MESSAGE.message_type},#{MESSAGE.message_title},#{MESSAGE.description},#{MESSAGE.customer_content},#{MESSAGE.url}, DATE())
    </insert>

    <select id="selectMessageByID" resultType="com.teradata.pushserver.bean.message.PushMessageBean">
        SELECT
            ID,
            MESSAGE_TYPE,
            MESSAGE_TITLE,
            DESCRIPTION,
            URL,
            CONTENT,
            CREATE_TIME
        FROM
            ${dbName}.KPI_MBL_BI_PUSH_MESSAGE
        WHERE
            ID = #{ID}
    </select>
    <select id="selectMessagesByUser" resultType="com.teradata.pushserver.bean.message.UserPushMessageBean">
        SELECT
            M.ID,
            M.MESSAGE_TYPE,
            M.MESSAGE_TITLE,
            M.DESCRIPTION,
            M.URL,
            M.CONTENT,
            M.CREATE_TIME,
            UM.STATUS,
            UM.RECEIVE_TIME
        FROM
            ${dbName}.KPI_MBL_BI_PUSH_USER_MESSAGE UM
        INNER JOIN
            ${dbName}.KPI_MBL_BI_PUSH_MESSAGE M
            ON UM.MESSAGE_ID = M.ID
        WHERE
            UM.USERNAME = #{USERNAME}
          AND
            UM.STATUS &lt;&gt; '2'
    </select>

    <update id="updateMessageStatus">
        UPDATE
            ${dbName}.KPI_MBL_BI_PUSH_USER_MESSAGE
        SET
            STATUS = #{STATUS}
        <if test="STATUS == 1">
            , RECEIVE_TIME =  DATE()
        </if>
        WHERE
            USERNAME = #{USERNAME}
        AND
            MESSAGE_ID = #{MESSAGE_ID}
    </update>

    <select id="insertUserMessage">
        INSERT INTO
          ${dbName}.KPI_MBL_BI_PUSH_USER_MESSAGE (USERNAME, MESSAGE_ID, STATUS, PUSH_TIME)
        VALUES
          (#{USER_MESSAGE.username}, #{USER_MESSAGE.id}, #{USER_MESSAGE.status}, DATE())
    </select>

    <select id="insertMessageToAllUser">
        INSERT INTO
          #{dbName}.KPI_MBL_BI_PUSH_USER_MESSAGE (USERNAME, MESSAGE_ID, STATUS, PUSH_TIME)
          SELECT
           DISTINCT USERNAME,
            #{USER_MESSAGE.id}   AS MESSAGE_ID,
            #{USER_MESSAGE.status}   AS STATUS,
            DATE()} AS PUSH_TIME
          FROM #{dbName}.KPI_MBL_BI_PUSH_BIND
    </select>
</mapper>